---
title: "Tutorial 1: simplest point process model"
author: "Ian Flint and Roozbeh Valavi"
date: "`r Sys.Date()`"
output: 
  pdf_document
vignette: >
  %\VignetteIndexEntry{Species distribution modelling with Poisson point processes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
always_allow_html: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 80), fig.align="center", message = FALSE, warning = FALSE, fig.height = 5, fig.width = 5)

set.seed(1)
```

In this document, we show how to fit the simplest point process model namely, Poisson process model.


## Setup and R libraries

```{r}
## working with spatial data
library(maptools) # convert raster to spatstat format
library(terra) # working with raster data

## modelling 
library(spatstat) # fitting and exploring ppm models
```


## Species data

Reading species data....

Note that the spatial coordinate system is a metric CRS...

```{r}
occurrences <- read.csv("data/species/occurrences.csv")
head(occurrences)

```


## Environmental data

We read raster covariate here....

We need to centre and scale covariate to ... 

```{r}
files <- list.files("data/rasters/", pattern = ".tif$", full.names = TRUE)
# get the 19 bio-climatic variables
r <- terra::rast(files)
rasters <- terra::scale(r, center=TRUE, scale=TRUE)

# plot a few of them
plot(rasters[[1]])
points(occurrences)

```


## Converting everything to `spatstat` objects

Covariates are usually specified in their image objects `spatstat::im`.
Internally, this is represented as a large pixel matrix, so conversion from rasters and other image objects is usually straightforward.
In order to convert to the proper format, the `maptools` helper function is useful.

```{r}
covariates <- lapply(rasters, as.im)
names(covariates) <- names(rasters)

plot(covariates[[1]], main = names(covariates)[1])

```


Next, when working with `spatstat` you need an observation window (region).
It is a region in which the points are assumed to be drawn from. 
The probability of finding locations outside of this region is assumed to be zero.
Common ways to construct an `spatstat::owin` is to either take a fixed rectangle, i.e. `window <- owin(c(0, 100), c(0, 100))`, or to use an existing covariate or raster to construct the window.

```{r}
window <- spatstat.geom::as.owin(covariates[[1]])
plot(window)

```


Occurrences (or presence points) are `spatstat::ppp` objects, and basically you need a vector of x-values, a vector of y-values, and the observation window.

```{r}
configuration <- spatstat.geom::ppp(x = occurrences$X, 
                                    y = occurrences$Y,
                                    window = window)
plot(configuration)

```

## Pre-modelling diagnostics

It is usually a good idea to start by a ``static'' analysis of the point pattern, without yet involving covariates.

```{r}
summary(configuration)

point_density <- spatstat.core::density.ppp(configuration, sigma = 1e5)
plot(log(point_density + 1e-11)) # a very small arbitrary value to avoid log of zero
points(configuration, pch = 16, cex = 0.2)

```

Here, we use `K` function to assess the clustering .... there are other functions such as `L` function and `g` function.


```{r}
plot(spatstat.core::Kinhom(configuration, 
                           correction = "translate", 
                           normpower = 2))

```


## Modelling with Poisson point process

Doing inference on the point pattern is just as easy as setting up a `glm` regression.
Start by writing the formula, essentially `formula <- "configuration ~ covariates`

```{r}
formula <- paste0("configuration ~ ", paste0(names(covariates), collapse = " + "))
print(formula)
```

The fitting function (analogue of `glm`) is `spatstat::ppm` and is used as follows.

```{r}
fit <- spatstat.core::ppm(as.formula(formula), covariates = covariates)

```

The fitted regression is manipulated in the same way as a `glm` fit is, so for example you can have a look at the summary

```{r}
summary(fit)
```

or do an ANOVA.

```{r}
updated_form <- paste0("configuration ~ ", paste0(names(covariates)[names(covariates) != "bio_15"], collapse = " + "))

updated_fit <- spatstat.core::ppm(as.formula(updated_form), covariates = covariates)

anova(fit, updated_fit)

```

To look at the predicted intensity, you use the `spatstat.core::predict.ppm` function.

```{r}
pred <- spatstat.core::predict.ppm(fit, covariates = covariates, dimyx = c(1024, 1024))

plot(log(pred))
points(configuration, pch = 16, cex = 0.2)

```
