---
title: 'Tutorial 0: data preparation for point process modelling'
author: "Ian Flint and Roozbeh Valavi"
date: "`r Sys.Date()`"
output: 
  pdf_document
vignette: >
  %\VignetteIndexEntry{Species distribution modelling with Poisson point processes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
always_allow_html: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 80), fig.align="center", message = FALSE, warning = FALSE, fig.height = 5, fig.width = 5)

set.seed(1)
```



## Setup and R libraries

```{r}
## working with spatial data
library(maptools) # convert raster to spatstat format
library(sf) # working with spatial vector data
library(terra) # working with raster data

## modelling 
library(spatstat) # fitting and exploring ppm models

## data cleaning and plotting
library(geodata) # downloading raster data for modelling
library(spocc) # downloading example species data
library(tmap) # plotting spatial data
library(tidyverse) # data cleaning and wrangling

```


```{r}
tmap::tmap_mode("view") # setting for tmap package
download_path <- "outputs/"
# reading helper functions
source("R/helper_functions.R")
```




## Downloading species data

We begin by loading the data containing recorded occurrences of koalas.

```{r}

#****** maybe replacing this with geodata package to remove one dependency
#*
#*
occ <- spocc::occ(query = "Phascolarctos cinereus", 
                          from = "gbif",
                          date = c("2010-01-01", "2020-12-31"),
                          gbifopts = list(country = "AU"),
                          has_coords = TRUE, 
                          limit = 1e4)

df <- spocc::occ2df(occ)

```

Citizen science data have often duplicated and mistake coordinates...

Cleaning the data to remove unlikely points... in this case there are some points in .... that we remove by filtering the longitude. You might need to check your desired species data and remove the unlikely records.

```{r}
point_data <- dplyr::filter(df, longitude > 135.3516) %>% 
  dplyr::select(longitude, latitude)

head(point_data)
```


The locations are shown below.

```{r}
dpts <- sf::st_as_sf(point_data, coords = c("longitude", "latitude"), crs = 4326)

tmap::tm_basemap() +
  tm_shape(dpts) + 
  tm_dots()

```

## Environmental data

```{r}
aus_boundary <- geodata::gadm(country = "AUS",
                              level = 1,
                              resolution = 2,
                              path = download_path)

# get the 19 bio-climatic variables
raster_covars <- geodata::worldclim_global(var = "bio",
                                           res = 10,
                                           path = download_path) %>% 
  terra::crop(aus_boundary) %>% 
  terra::mask(aus_boundary)


# change the names of covariates by cleaning the name
names(raster_covars) <- str_sub(names(raster_covars), 11, 100)

# plot a few of them
plot(raster_covars[[1:6]])

```

## Removing correlated covariates


```{r}
vif <- usdm::vifstep(raster::stack(raster_covars))
vif

```


```{r}
uncorr_names <- vif@results$Variables
selected_covars <- raster_covars[[uncorr_names]]
```



## Data projection

For PPM it is better to have the data in a metric reference systems...

Some lectures on CRS by Roozbeh...

We need to change both raster and point data into one projections.

```{r}
###******** change this to GDA 2020 Lambert *******
output_crs <- 7855

```


```{r}
rasters <- terra::project(selected_covars, paste0("epsg:", output_crs))
plot(rasters[[1]], main = names(rasters)[1])

```


```{r}
occ_transfomed <- crs_transform(cleaned_data, 
                                in_crs = 4326, 
                                out_crs = output_crs)
head(occ_transfomed)

```





## Let's clean the coordinates of occurrence

Make use that all the layers have the same NA data. By taking a `min` or `max` function a mask layer is created as an one raster layer with NA will result in NA in the mask layer.


```{r}
# function is from the helper_functions.R
occurrences <- clean_occ(points = occ_transfomed, 
                         r = rasters[[1]], 
                         remove_outside = TRUE, 
                         remove_dup_dist = 0,
                         crs = output_crs)

```


## Writing data to disk

```{r}
write.csv(occurrences, "data/species/occurrences.csv", row.names = FALSE)

```


```{r}
terra::writeRaster(
  x = rasters,
  filename = paste0("data/rasters/", names(rasters), ".tif")
)
```








