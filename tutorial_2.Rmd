---
title: 'Tutorial 2: point process advanced topics'
author: "Ian Flint and Roozbeh Valavi"
date: "`r Sys.Date()`"
output: 
  pdf_document
vignette: >
  %\VignetteIndexEntry{Species distribution modelling with Poisson point processes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
always_allow_html: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 80), fig.align="center", message = FALSE, warning = FALSE, fig.height = 5, fig.width = 5)

set.seed(1)
```



## Setup and R libraries

```{r}
library(spatstat) # fitting and exploring ppm models
library(terra) # working with raster data

```



## Cox process

Spatstat can handle many different types of correlation structures between individuals of the species.
You would usually supply an `interaction` parameter to `spatstat.core::ppm`.
However, initial analysis suggested attraction between the individuals, in which case a doubly-stochastic (Cox) point process is more appropriate.
Fitting such point processes uses another function, as shown below.

<!-- ```{r} -->
  <!-- fit_cox <- spatstat::kppm(as.formula(formula), covariates = covariates, clusters = "LGCP") -->
  <!-- summary(fit_cox) -->
  <!-- ``` -->
  
  <!-- A nice way to appreciate the difference in the underlying model is to draw from the fitted distribution. -->
  <!-- This can easily be done for the fitted Poisson point process. -->
  
  <!-- ```{r} -->
  <!-- draw_ppp <- spatstat::simulate.ppm(fit) -->
  <!-- plot(draw_ppp) -->
  <!-- ``` -->
  
  <!-- Drawing from a Cox point process requires you to use another library, but it essentially works in the same way. -->
  
  <!-- ```{r} -->
  <!-- library(RandomFields) -->
  <!-- library(RandomFieldsUtils) -->
  
  <!-- draw_cox <- spatstat::simulate.kppm(fit_cox) -->
  <!-- plot(draw_cox) -->
  <!-- ``` -->
  
  <!-- Making goodness-of-fit tests is straightforward, we refer in particular to the functions `spatstat::quadrat.test`, `spatstat::cdf.test`, `spatstat::dclf.test` and `spatstat::mad.test`. -->
  <!-- A lot of these functions rely on multiple simulations of the point process, which is going to be exeedingly slow for the Cox process. -->
  <!-- Instead, we show what a goodness-of-fit test looks like with a simple fit with a Poisson point process. -->
  
  <!-- ```{r} -->
  <!-- dclf.test(fit) -->
  <!-- ``` -->
  
  <!-- ## Comparing the results -->
  
  
  


## Fit Poisson process in Stan (Bayesian framework)

[](https://towardsdatascience.com/understanding-point-process-model-with-r-983553ca2a86)

```{r}
ppm_stan <- '
data{
  int<lower = 1> n;
  vector[n] x;
  int<lower = 0> y[n];
}
parameters{
  real beta0;
  real beta1;
}
transformed parameters{
}
model{
  //priors
  target += normal_lpdf(beta0 | 0,5);
  target += normal_lpdf(beta1 | 0,10);// likelihood
  target += poisson_log_lpmf(y | beta0 + beta1 * x);
}
generated quantities{
  vector[n] lambda_rep;
  lambda_rep = exp(beta0 + beta1 * x);
}'

```

